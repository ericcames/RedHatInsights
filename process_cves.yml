---
  - name: Get the list of CVEs related to the server
    hosts: localhost
    connection: local
    gather_facts: no
    vars:
      chg_tasks_raw: ''

    tasks:

    - name: Get my list of CVEs
      register: my_cve_list
      ignore_errors: true
      ansible.builtin.uri:
        url: "https://console.redhat.com/api/vulnerability/v1/systems/{{ my_insights_inventory_id }}/cves"
        method: GET
        user: "{{ insights_username }}"
        password: "{{ insights_password }}"
        validate_certs: no
        force_basic_auth: yes
        status_code: 200
        return_content: yes 
        headers:
          Content-Type: "application/json"
    
    - name: Create a change task for each cve with a playbook
      register: task_numbers_are_here
      loop: "{{ my_cve_list['json']['data'] }}"
      when: item.attributes.remediation == 2
      servicenow.itsm.change_request_task:
        configuration_item: "{{ my_server }}"
        change_request_number: "{{ ticket_number }}"
        type: implementation
        state: open
        assigned_to: "hercules"
        assignment_group: "Ansible West Tigers"
        short_description: "vulnerabilities:{{ item.attributes.synopsis }} on Red Hat Insights Inventory ID: {{ my_insights_inventory_id }}"
        description: "{{ item.attributes.description }}"
        on_hold: true
        hold_reason: "Waiting for Ansible Automation Platform to run the remediation playbook."
        other:
          approval: approved

    - name: Create problem for each cve without a playbook
      register: problem_numbers_are_here
      loop: "{{ my_cve_list['json']['data'] }}"
      when: item.attributes.remediation != 2
      servicenow.itsm.problem:
        state: new
        short_description: "Red Hat Insights vulnerabilities:{{ item.attributes.synopsis }} exists on {{ my_server }} and there is no available Ansible Playbook :-0"
        description: "{{ item.attributes.description }}"
        impact: medium
        urgency: low
        other:
          user_input: "Red Hat Insights Inventory ID: {{ my_insights_inventory_id }}"

    - name: Update a fact for change ticket task numbers; white space delimited
      loop: "{{ task_numbers_are_here['results'] }}"
      when: item.changed != false
      ansible.builtin.set_fact:
        chg_tasks_raw: "{{ chg_tasks_raw + item.record.number }} "
    
    - name: Convert chg_tasks_raw to a white space delimted list
      ansible.builtin.set_fact:
        chg_tasks: "{{ ' '.join(chg_tasks_raw.split()) }}"

    # - name: Print a list of change related task tickets
    #   ansible.builtin.debug:
    #     msg: "{{ (chg_tasks_raw.split()) }}"

    - name: Print a list of change related task tickets
      loop: "{{ (chg_tasks_raw.split()) }}"
      ansible.builtin.debug:
        msg: "{{ item }}"